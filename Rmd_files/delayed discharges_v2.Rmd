---
title: "Untitled"
author: "Andrew Saul"
date: "14/02/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
if(!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

librarian::shelf(tidyverse, here, fs, rvest ,xml2, openxlsx, lubridate, readxl, janitor, glue, rlang, plotly)
source(here::here("scripts", "my_funcs.R"))
source(here::here("scripts", "populations.R"))
```

```{r historical-stats}
# getLAPops acquires pop data stored in an .rds file
#find pops for ages>= 18 for all LAs and Scotland
# NO SCOTLAND POP DATA WITH THIS .RDS

# no data available for mid-pop estimate for 2021.  
# locf (last observation carried forward) utilised from 2020 for 2021
#Scotland pop values created by summing all CouncilAreas.
LA_pop_18plus <- getLAPops(age_lowest = 18)

```

```{r download-NRS-recent-data}
#file downloaded from NRS website if filename not present in data folder

data_filename <- "beddays"
#if(!file_exists(here::here("data", glue("{data_filename}.xlsx")))){
download_data(filename = data_filename)

```

```{r convert-to-tibbles}
# save pathname of beddays xlsx file to object 
xl_file <- here::here("data", glue("{data_filename}.xlsx"))

#create a single tibble containing both healthboard and LA data, as "Scotland" located in HB... sheets. Only "Scotland" kept from HB... sheets 
# change format of FY (eg 1718)to year of start FY (2017)
tib <- map_dfr(create_sheetname_vector(xl_file), # vector of LA and HB data from FY 12/13 until 21/22
              ~create_FY_authority(xl_file, sheet_name = .x)) 

######################################################################################
#create tibble with FY to date 
tib_fytd <- tib %>% 
  select("CouncilArea", "AgeGroup", "ComplexNeedsFlag", "FYToDate", "FY", "FY_begin") %>% 
  rename(Counts = FYToDate) %>% 
  add_GGC_field()

######################################################################################
#create tibble with Month/Year Counts
# used to 1- select columns for pivoting & 2- set order of months
month_order <- c("April", "May", "June", "July", "August", "September",
                   "October", "November", "December", "January", "February",
                   "March")

tib_FY_CA<- get_FY_CA_data(tib) %>% 
  add_GGC_field()

```

```{r}
#############################
#fydata is in format "yy/yy"#
#############################

#Scotland values obtained from HBData sheets

# use scot_flag = TRUE to get Scotland values,
# use ggc_flag = TRUE to get GGC values
# use month_flag = FALSE if calculating FY to date values

# Dec 2021 Code9 rates
############Scotland######################
## December 2021##
get_group_bed_rates(tib_FY_CA, CNeeds_string = "Code 9",  fydate=2122, mon= "December", ggc_flag = FALSE, scot_flag = TRUE) %>% 
  get_group_bedrate_value()

## up to Dec 2021 Scotland figures ##
get_group_bed_rates(tib_fytd, CNeeds_string = "Code 9", fydate=2122, ggc_flag = FALSE, scot_flag = TRUE)  %>% 
  get_group_bedrate_value()

################GGC group value#################
## Dec 2021 ##
get_group_bed_rates(tib_FY_CA, CNeeds_string = "Code 9", fydate=2122,  mon = "December", ggc_flag = TRUE) %>% 
  get_group_bedrate_value()

## up to Dec 2021 ##
get_group_bed_rates(tib_fytd,  CNeeds_string = "Code 9", fydate=2122, ggc_flag = TRUE)  %>% 
  get_group_bedrate_value()

######## All Council Areas ################################################
## December ##
 get_group_bed_rates(tib_FY_CA, CNeeds_string = "Code 9", fydate=2122, mon = "December")

## up to Dec FY##
get_group_bed_rates(tib_fytd, CNeeds_string ="Code 9", fydate=2122)

```


```{r}
#Previous 5 year data excluding year 2021
#Vector of Council Areas
CA_names <- get_council_area_names(tib_FY_CA) # all regions

#list of all Councils containing tibbles for min,max, avg current values
all_rates <- map(CA_names, ~get_rates(tib=tib_FY_CA, CA= .x, CNeeds_string = "Code 9", fydate=2122, pop_objfile=LA_pop_18plus)) %>% 
  set_names(., CA_names)


map(all_rates, create_5yr_plot)

create_5yr_plot(all_rates, index=1, CNeeds_string ="Code 9")
```

